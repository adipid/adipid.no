{% macro bloglisting(posts, showDescription=true) %}
  {% for year, posts in posts | group_by(attribute="year") %}
    <div class="bloglisting__year">
      <div class="bloglisting__header">
        <h2>{{ year }}</h2>
        <span>
          ({{ posts | length }} entr{{ posts | length | pluralize(singular="y", plural="ies") }})
        </span>
      </div>
      <ul class="blog">
        {% for post in posts %}
          {{ macros::bloglisting_item(post=post) }}
        {% endfor %}
      </ul>
    </div>
  {% endfor %}
{% endmacro %}

{% macro bloglisting_item(post, showDescription=true) %}
  <li class="blog__post">
    <div class="post__summary">
      <a href="{{ get_url(path=post.path) }}">
        {{ post.title }}</a>
      {% if showDescription %}
        <p> {{ post.description }} </p>
      {% endif %}
    </div>
    <div class="post__date">
      <time class="font-mono" datetime="{{ post.date | date(format="%Y-%m-%d") }}">
        {{ post.date | date(format="%Y-%m-%d") }}
      </time>
    </div>
  </li>
{% endmacro %}

{% macro backlinks(page, title="page") %}
  {% if page.backlinks %}
    <div class="backlinks">
      <h2>{{ trans(key="also_mentioned_in", lang=lang) }}</h2>
      <ul class="backlinks__list">
        {% for backlink in page.backlinks %}
        <li>
          <a href="{{ backlink.permalink }}">
            {{ backlink.title }}
          </a>
        </li>
        {% endfor %}
      </ul>
    </div>
  {% endif %}
{% endmacro %}

{% macro cv_experiences(title, array) %}
<section class="experiences">
  <h2 class="experiences__title">{{ title }}</h2>

  {% for experience in array %}
    <article class="experience">
      <header class="experience__header">
        <h3 class="experience__name">
          {{ experience.position }} 
        </h3>
        <div class="role__name">
          {% if experience.url %}
            <a href="{{ experience.url }}" target="_blank">
              {{ experience.name }}
            </a>
          {% else %}
            {{ experience.name }}
          {% endif %}
          <span>
            {{ experience.startDate | date(format="%b %Y") }} - {% if
            experience.endDate %}{{ experience.endDate | date(format="%b %Y") }}{% else %}present{%
            endif %}
          </span>
        </div>
      </header>
      <div class="experience__role">
        {% if experience.highlights %}
          {% if experience.highlights | length > 1 %}
          <ul class="role__list">
            {% for highlight in experience.highlights %}
            <li class="role__list-item">{{ highlight }}</li>
            {% endfor %}
          </ul>
          {% else %}
            <p class="role__description">{{ experience.highlights | first }}</p>
          {% endif %}
        {% endif %}
      </div>
    </article>
  {% endfor %}
</section>
{% endmacro %}

{% macro cv_education(title, array) %}
<section class="experiences">
  <h2 class="experiences__title">{{ title }}</h2>

  {% for experience in array %}
    <article class="experience">
      <header class="experience__header">
        <h3 class="experience__name">
          {{ experience.studyType }} in {{ experience.area }}
        </h3>
        <div class="role__name">
          {% if experience.url %}
            <a href="{{ experience.url }}" target="_blank">
              {{ experience.insitution }}
            </a>
          {% else %}
            {{ experience.instituion }}
          {% endif %}
          <span>
            {{ experience.startDate | date(format="%b %Y") }} - {% if
            experience.endDate %}{{ experience.endDate | date(format="%b %Y") }}{% else %}present{%
            endif %}
          </span>
        </div>
      </header>
      <div class="experience__role">
        <p class="role__description">{{ experience.summary }}</p>
      </div>
    </article>
  {% endfor %}
</section>
{% endmacro %}

{% macro toc(toc, level=2) %}
<h2>{{ trans(key="toc", lang=lang) }}</h2>
<ul>
  {% for item in toc %}
    <li>
      <a href="{{ item.permalink }}">{{ item.title }}</a>
      {% if level > 1 and item.children %}
        <ul>
          {% for child in item.children %}
            <li>
              <a href="{{ child.permalink }}">{{ child.title }}</a>
              {% if child.children %}
                <ul>
                  {% for grand_child in child.children %}
                    <li>
                      <a href="{{ grand_child.permalink }}">{{ grand_child.title }}</a>
                    </li>
                  {% endfor %}
                </ul>
              {% endif %}
            </li>
          {% endfor %}
        </ul>
      {% endif %}
    </li>
  {% endfor %}
</ul>
{% endmacro %}

{% macro subpages() %}
  {% if section.subsections %}
    <ul class="sections__list">
    {% for sub_section in section.subsections | sort %}
      {% set subsection = get_section(path=sub_section) %}
      <li class="list__item">
        <a href="{{ subsection.permalink }}">
          {{ subsection.title }}
        </a>
        <ul class="pages__list">
          {% for page in subsection.pages | sort(attribute="title") %}
            <li class="list__item">
                <a href="{{ page.permalink }}">
                  {{ page.title }}
                </a>
            </li>
          {% endfor %}
        </ul>
      </li>
      {% endfor %}
      {% if section.pages %}
        {% for page in section.pages | sort(attribute="title") %}
          <li class="list__item">
              <a href="{{ page.permalink }}">
                {{ page.title }}
              </a>
          </li>
        {% endfor %}
      {% endif %}
    </ul>
  {% else %}
    <nav aria-label="Subpages">
      <ul class="pages__list">
        {% for page in section.pages | sort(attribute="title") %}
          <li class="list__item">
              <a href="{{ page.permalink }}">
                {{ page.title }}
              </a>
          </li>
        {% endfor %}
      </ul>
    </nav>
  {% endif %}
{% endmacro %}

{% macro breadcrumbs() %}
  {% set_global ancestors = section.ancestors | default(value=page.ancestors) %}

  <div class="breadcrumbs-wrapper">
    {% if ancestors | length > 0 %}
      <nav aria-label="Breadcrumbs">
        <ul class="breadcrumbs-list">
          {% for ancestor_raw in ancestors %}
            {% set ancestor = get_section(path=ancestor_raw) %}
            <li class="breadcrumbs-list__item">
              {% set_global defaultIndex = "Index" %}
              {% if lang == "no" %}
                {% set_global defaultIndex = "Hjem" %}
              {% endif %}
              <a href="{{ ancestor.permalink }}">{{ ancestor.title | default(value=defaultIndex) | safe }}</a>
            </li>
          {% endfor %}
          <li class="breadcrumbs-list__item">
            {{ section.title | default(value=page.title) | safe }}
          </li>
        </ul>
      </nav>
    {% endif %}
    {{ self::translation() }}
  </div>
{% endmacro %}

{% macro translation(prefix="") %}
  {% set_global url = "/" %}
  {% set_global translation = "" %}
  {% set_global swap_lang = "" %}
  {% if lang == "en" %}
    {% set_global swap_lang = "no" %}
    {% set_global url = "/no" %}
  {% else %}
    {% set_global swap_lang = "en" %}
  {% endif %}

  {% if page %}
    {% set_global translation = page.translations %}
  {% elif section %}
    {% set_global translation = section.translations %}
  {% endif %}
  {% for trans in translation %}
    {% if trans.lang == swap_lang %}
      {% set_global url = trans.permalink %}
    {% endif %}
  {% endfor %}
  {% set swap_lang_obj = load_data(literal='
    {
      "no": "🇳🇴 Norsk",
      "en": "🇺🇸 English"
    }
  ', format="json") %}
  <div class="{{ prefix }}translation">
    {% if translation|length > 1 %}
      <a class="translation__link" href="{{ url }}" hreflang="{{ swap_lang }}">
         <span lang="{{ swap_lang }}">{{ swap_lang_obj[swap_lang] }}</span>
      </a>
    {% endif %}
  </div>
{% endmacro %}


{% macro rating(max=5, rating) %}
  {% set rating = rating | int %}
  {% set diff = max - rating %}
  {% set desc = "Rating: " ~ rating ~ " out of " ~  max ~ " stars" %}

  <span aria-label="{{ desc }}" title="{{ desc }}">
    {% for star in range(end=rating) %}★{% endfor %}{% for star in range(end=diff) %}☆{% endfor %}
  </span>
{% endmacro %}

{% macro timeline(array, attribute_year, attribute_date) %}
  <div class="timeline-grid">
    {% for year, events in array | group_by(attribute=attribute_year) %}
      {% if year != "0" %}
        {% for date, items in events | group_by(attribute=attribute_date) %}
          <div class="timeline__item">
            <time class="font-mono" datetime="{{ date }}">{{ date }}</time>
            {% for item in items %}
              {{ self::timeline_item(item=item) }}
            {% endfor %}
          </div>
        {% endfor %}
      {% endif %}
      {% if year != "0" %}
        <time id="{{ year }}" class="timeline__year font-mono" datetime="{{ year }}">{{ year }}</time>
      {% endif %}
    {% endfor %}
  </div>
{% endmacro %}

{% macro timeline_item(item) %}
<div class="timeline__item__wrapper" data-tag="{{ item.type | slugify }}">
    <h2>
      <div class="type">
        {% if item.details.custom_prefix %}
          {{ item.details.custom_prefix }}
        {% else %}
          {% set occasion = item.details.occasion | default(value="") %}
          {{ self::timeline_item_type(type=item.type, occasion=occasion) }}
        {% endif %}
      </div>
      {% if not item.type == "travel" %}
        {{ item.title }}
      {% else %}
        {% if item.details.occasion == "business" %}
          {{ item.details.location.cities[0] }}
        {% else %}
          {{ item.details.location.country }} - {{ item.details.location.cities | join(sep=", ") }}
        {% endif %}
      {% endif %}
    </h2>
    {% if item.details.my_rating %}
      <p>{{ self::rating(rating=item.details.my_rating) }}</p>
    {% endif %}
    {% if item.description %}
      <p>{{ item.description }}</p>
    {% endif %}
  </div>
{% endmacro %}

{% macro timeline_item_type(type="other", occasion) %}
  {% set types = load_data(literal='
    {
      "movie": "🍿 Watched",
      "tv": "🍿 Watched",
      "book": "📚 Read",
      "game": "🎮 Completed",
      "life": "🍀 Life",
      "travel": {
        "business": "✈️ Business trip",
        "pleasure": "✈️ Travel"
      },
      "other": "Other"
    }
  ', format="json" ) %}

  {% if type == "travel" %}
    {{ types[type][occasion] }}
  {% else %}
    {{ types[type] }}
  {% endif %}
{% endmacro %}

{% macro bookmark_item(bookmark) %}
  <div class="bookmark">
    <h2 class="bookmark__title">
      <a href="{{ bookmark.url }}">
        {% if bookmark.title != "" %}
          {{ bookmark.title }}
        {% else %}
          {{ bookmark.website_title }}
        {% endif %}
      </a>
    </h2>
    {% if bookmark.description %}
      <p class="bookmark__desc">
        {{ bookmark.description }}
      </p>
    {% endif %}
    <div class="bookmark__metadata">
      <div class="bookmark__date_added">
        Bookmarked
        {% set format = trans(key="date_format_long", lang=lang) %}
        {{ bookmark.date_added | date(format=format) }}
      </div>
      {% if bookmark.tag_names %}
        <ul aria-label="Bookmark's tags" class="bookmark__tags">
          {% for tag in bookmark.tag_names | sort %}
            <li>#{{ tag }}</li>
          {% endfor %}
        </ul>
      {% endif %}
    </div>
  </div>
{% endmacro %}

{% macro project_item(project) %}
  <div class="project">
    <h2 class="project__title">
      {% if project.url %}
        <a href="{{ project.url }}" target="_blank">
          {{ project.name }}
        </a>
      {% else %}
        {{ project.name }}
      {% endif %}
    </h2>
    {% if project.description %}
      <p class="project__desc">
        {{ project.description }}
      </p>
    {% endif %}
    {% if project.sources %}
      <p><a href="{{ project.sources[0] }}" target="_blank">Source code</a></p>
    {% endif %}
    <div class="project__metadata">
      <div class="project__date_added"></div>
      {% if project.keywords %}
        <ul aria-label="Project's tags" class="project__tags">
          {% for tag in project.keywords | sort %}
            <li data-tag="{{ tag | slugify }}">#{{ tag | lower }}</li>
          {% endfor %}
        </ul>
      {% endif %}
    </div>
  </div>
{% endmacro %}
